 <div class="min-h-screen w-screen bg-gray-50">
    <!-- Header -->
    <header class="sticky top-0 z-10 bg-white shadow-sm">
        <div class="mx-auto max-w-7xl px-6">
            <div class="flex items-center justify-between py-3">
                <div class="flex items-center gap-4">
                    <div class="inline-block rounded-2xl bg-fidelity-primary/10 p-2 ring-2 ring-fidelity-primary/20">
                        <img src="https://pbs.twimg.com/profile_images/1767198674373734400/R9lqG20r_400x400.jpg" alt="Fidelity Insurance Logo" class="h-8 w-8 sm:h-10 sm:w-10 rounded-xl object-cover ring-2 ring-fidelity-primary shadow-lg" />
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-fidelity-primary sm:text-xl">Fidelity Travel Insurance</h1>
                        <p class="text-xs font-semibold tracking-wide text-fidelity-primary">Insurance You can Trust</p>
                    </div>
                </div>
                <button (click)="closeForm()" class="flex items-center gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50" title="Close">
                    <mat-icon class="!h-4 !w-4 !text-base">close</mat-icon>Close
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="p-6">
        <div class="mx-auto max-w-7xl">
            <!-- Progress Steps -->
            <div class="mb-8">
                 <div class="flex items-center">
                    <div class="flex items-center" [class.text-fidelity-primary]="currentStep >= 1" [class.text-gray-500]="currentStep < 1">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-fidelity-primary]="currentStep >= 1" [class.text-white]="currentStep >= 1" [class.bg-gray-300]="currentStep < 1">1</div>
                        <span class="ml-2 text-sm font-medium">Quote & Select Plan</span>
                    </div>
                    <div class="mx-4 h-px flex-1" [class.bg-fidelity-primary]="currentStep > 1" [class.bg-gray-300]="currentStep <= 1"></div>
                    <div class="flex items-center" [class.text-fidelity-primary]="currentStep >= 2" [class.text-gray-500]="currentStep < 2">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-fidelity-primary]="currentStep >= 2" [class.text-white]="currentStep >= 2" [class.bg-gray-300]="currentStep < 2">2</div>
                        <span class="ml-2 text-sm font-medium">Traveler Details</span>
                    </div>
                    <div class="mx-4 h-px flex-1" [class.bg-fidelity-primary]="currentStep > 2" [class.bg-gray-300]="currentStep <= 2"></div>
                    <div class="flex items-center" [class.text-fidelity-primary]="currentStep >= 3" [class.text-gray-500]="currentStep < 3">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-fidelity-primary]="currentStep >= 3" [class.text-white]="currentStep >= 3" [class.bg-gray-300]="currentStep < 3">3</div>
                        <span class="ml-2 text-sm font-medium">Review & Pay</span>
                    </div>
                </div>
            </div>

            <!-- Content Container -->
            <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                <!-- Left Column: Forms -->
                <div [ngClass]="{'lg:col-span-3': currentStep === 1, 'lg:col-span-2': currentStep > 1}">
                    <!-- Step 1: Quote Form & Plan Selection -->
                    <div *ngIf="currentStep === 1" class="step-content">
                        <form [formGroup]="quoteForm">
                            <div class="rounded-lg bg-white p-6 shadow-sm">
                                <h2 class="mb-2 text-2xl font-semibold text-gray-900">Get Your Travel Insurance Quote</h2>
                                <p class="mb-6 text-gray-600">Tell us about your trip to see available plans and pricing.</p>
                                <div class="grid grid-cols-1 gap-x-6 gap-y-4">
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Cover Period<span class="text-red-500">*</span></label>
                                        <select formControlName="duration" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2">
                                            <option value="" disabled>Select duration</option>
                                            <option *ngFor="let d of standardDurations" [value]="d.value">{{ d.label }}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
    
                            <div *ngIf="qf.duration.value" class="mt-8">
                                <h3 class="mb-4 text-xl font-semibold text-gray-800">Select a Plan</h3>
                                <div class="grid grid-cols-3 gap-6">
                                    <div *ngFor="let plan of displayedPlans" class="plan-card" [ngClass]="{'selected-plan': qf.plan.value === plan.id}">
                                        <div class="p-6">
                                            <div class="plan-price">
                                                <span class="price-amount">KES {{ (plan.priceUSD * USD_TO_KES_RATE) | number:'1.0-0' }}</span>
                                                <div class="price-period">per person</div>
                                            </div>
                                            <div class="plan-tags">
                                                <span *ngFor="let tag of plan.tags" class="plan-tag">{{ tag }}</span>
                                            </div>
                                            <ul class="plan-benefits">
                                                <li *ngFor="let benefit of plan.benefits" class="benefit-item">
                                                    <mat-icon class="benefit-icon included">check_circle</mat-icon>
                                                    <div class="benefit-text">
                                                        <div class="benefit-name">{{ benefit.name }}</div>
                                                        <div class="benefit-details">
                                                            <span *ngIf="benefit.limit" class="benefit-limit">{{ benefit.limit }}</span>
                                                            <span *ngIf="benefit.notes" class="benefit-notes">{{ benefit.notes }}</span>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                        <label class="p-6 pt-0 mt-auto">
                                            <input type="radio" formControlName="plan" [value]="plan.id" class="sr-only"/>
                                            <span class="select-button">Select Plan</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="mt-8 flex justify-end">
                            <button (click)="nextStep()" [disabled]="quoteForm.invalid" class="rounded-md bg-fidelity-primary px-8 py-3 text-sm font-medium text-white hover:bg-white hover:text-fidelity-primary hover:border-2 hover:border-fidelity-primary transition-all duration-300 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed">Next</button>
                        </div>
                    </div>

                    <!-- Step 2: Traveler Details -->
                    <div *ngIf="currentStep === 2" class="step-content rounded-lg bg-white p-6 shadow-sm">
                        <h2 class="mb-2 text-2xl font-semibold text-gray-900">Traveler Details</h2>
                        <p class="mb-6 text-gray-600">Please provide contact info and details for all travelers.</p>
                        
                        <form [formGroup]="travelerDetailsForm">
                            <h3 class="mb-4 border-b pb-2 text-lg font-semibold text-gray-800">Primary Contact & Trip Info</h3>
                            <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                               <div>
                                   <label class="mb-2 block text-sm font-medium text-gray-700">Email Address<span class="text-red-500">*</span></label>
                                   <input type="email" formControlName="email" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                    <div *ngIf="tdf.email.invalid && (tdf.email.dirty || tdf.email.touched)" class="mt-1 text-xs text-red-500">
                                       <div *ngIf="tdf.email.errors?.['required']">Email address is required.</div>
                                       <div *ngIf="tdf.email.errors?.['email']">Please enter a valid email address.</div>
                                   </div>
                               </div>
                               <div>
                                   <label class="mb-2 block text-sm font-medium text-gray-700">Phone Number<span class="text-red-500">*</span></label>
                                   <input type="tel" formControlName="phoneNumber" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" placeholder="+254712345678" />
                                    <div *ngIf="tdf.phoneNumber.invalid && (tdf.phoneNumber.dirty || tdf.phoneNumber.touched)" class="mt-1 text-xs text-red-500">
                                       <div *ngIf="tdf.phoneNumber.errors?.['required']">Phone number is required.</div>
                                       <div *ngIf="tdf.phoneNumber.errors?.['pattern']">Must be in the format +2547... or +2541...</div>
                                   </div>
                               </div>
                               <div>
                                   <label class="mb-2 block text-sm font-medium text-gray-700">Number of Travelers<span class="text-red-500">*</span></label>
                                   <input type="number" formControlName="numTravelers" min="1" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                   <div *ngIf="tdf.numTravelers.invalid && (tdf.numTravelers.dirty || tdf.numTravelers.touched)" class="mt-1 text-xs text-red-500">
                                       <div *ngIf="tdf.numTravelers.errors?.['required']">Number of travelers is required.</div>
                                       <div *ngIf="tdf.numTravelers.errors?.['min']">At least one traveler is required.</div>
                                   </div>
                               </div>
                            </div>

                            <div class="mt-8" formArrayName="travelers">
                                <h3 class="mb-4 border-b pb-2 text-lg font-semibold text-gray-800">Traveler Information</h3>

                                <!-- NEW: Duplicate Traveler Error Message -->
                                <div *ngIf="travelers.hasError('duplicateTraveler') && travelers.touched" class="mb-4 rounded-md bg-red-50 p-3 text-center text-sm text-red-600">
                                    Error: Each traveler must have a unique combination of full name and date of birth.
                                </div>
                                
                                <div *ngFor="let travelerGroup of travelers.controls; let i = index" [formGroupName]="i" class="mb-6 rounded-md border bg-gray-50/50 p-4">
                                    <h4 class="mb-4 font-medium text-gray-700">
                                        {{ i === 0 ? 'Primary Traveler' : 'Traveler ' + (i + 1) }}
                                    </h4>
                                    <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                                        <div>
                                            <label class="mb-2 block text-sm font-medium text-gray-700">Full Name<span class="text-red-500">*</span></label>
                                            <input type="text" formControlName="fullName" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                            <div *ngIf="travelerGroup.get('fullName')?.invalid && (travelerGroup.get('fullName')?.dirty || travelerGroup.get('fullName')?.touched)" class="mt-1 text-xs text-red-500">
                                                <div *ngIf="travelerGroup.get('fullName')?.errors?.['required']">Full name is required.</div>
                                                <div *ngIf="travelerGroup.get('fullName')?.errors?.['invalidName']">Please enter at least two names (e.g., John Doe).</div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="mb-2 block text-sm font-medium text-gray-700">Date of Birth<span class="text-red-500">*</span></label>
                                            <input type="date" formControlName="dob" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                            <div *ngIf="travelerGroup.get('dob')?.invalid && (travelerGroup.get('dob')?.dirty || travelerGroup.get('dob')?.touched)" class="mt-1 text-xs text-red-500">
                                                <div *ngIf="travelerGroup.get('dob')?.errors?.['required']">Date of birth is required.</div>
                                                <div *ngIf="travelerGroup.get('dob')?.errors?.['futureDate']">Date of birth cannot be in the future.</div>
                                                <div *ngIf="travelerGroup.get('dob')?.errors?.['tooOld']">Please enter a valid year.</div>
                                            </div>
                                            <!-- NEW: Minor Declaration -->
                                            <div *ngIf="travelerGroup.get('dob')?.valid && getAge(travelerGroup.get('dob')?.value) < 18" class="mt-1 text-xs font-semibold text-blue-600">
                                                (This traveler is a minor)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex items-center">
                               <input type="checkbox" formControlName="winterSports" id="winterSports" class="h-4 w-4 rounded border-gray-300 text-fidelity-primary focus:ring-fidelity-primary" />
                               <label for="winterSports" class="ml-2 text-sm text-gray-700">Add Winter Sports cover (Optional Surcharge)</label>
                           </div>
                       </form>
                    </div>

                    <!-- Step 3: Review & Pay -->
                    <div *ngIf="currentStep === 3" class="step-content rounded-lg bg-white p-6 shadow-sm">
                        <h2 class="mb-6 text-2xl font-semibold text-gray-900">Review Your Quote</h2>
                        <div class="review-section">
                            <h4>Trip Details</h4>
                            <div class="review-grid">
                                <span class="label">Plan</span><span class="value">{{ selectedPlanDetails?.name }}</span>
                                <span class="label">Cover Period</span><span class="value">{{ getDurationText(quoteForm.value.duration) }}</span>
                                <span class="label">Travelers</span><span class="value">{{ travelerDetailsForm.value.numTravelers }}</span>
                            </div>

                            <h4>Contact Information</h4>
                            <div class="review-grid">
                                <span class="label">Email</span><span class="value">{{ travelerDetailsForm.value.email }}</span>
                                <span class="label">Phone</span><span class="value">{{ travelerDetailsForm.value.phoneNumber }}</span>
                            </div>

                             <div class="mt-4">
                                <h4 class="font-semibold text-gray-800">Insured Travelers</h4>
                                <ul class="mt-2 space-y-1">
                                    <li *ngFor="let traveler of travelerDetailsForm.value.travelers" class="text-gray-600">
                                        {{ traveler.fullName }} (DOB: {{ traveler.dob | date:'longDate' }})
                                    </li>
                                </ul>
                            </div>

                            <h4 class="mt-8">Full Plan Benefits</h4>
                            <table *ngIf="selectedPlanDetails" class="benefit-table">
                                <thead>
                                    <tr>
                                        <th>Benefit</th>
                                        <th>Limit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ng-container *ngFor="let benefit of selectedPlanDetails.benefits">
                                        <tr *ngIf="benefit.included">
                                            <td>{{ benefit.name }}</td>
                                            <td>{{ benefit.limit }} <span *ngIf="benefit.notes">({{benefit.notes}})</span></td>
                                        </tr>
                                    </ng-container>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Premium Summary & Navigation (HIDDEN in Step 1) -->
                <div *ngIf="currentStep > 1" class="lg:col-span-1">
                    <div class="sticky top-24 rounded-lg bg-white p-6 shadow-sm">
                        <h3 class="mb-4 text-lg font-semibold text-gray-900">Premium Summary</h3>
                        <div class="summary-bg space-y-3 rounded-lg p-4 text-sm">
                            <div class="flex justify-between font-semibold">
                                <span>Subtotal (USD)</span><span>$ {{ premium.subtotalUSD | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.groupDiscountUSD > 0" class="flex justify-between text-green-600">
                                <span>Group Discount ({{ premium.groupDiscountPercentage }}%)</span>
                                <span>- $ {{ premium.groupDiscountUSD | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.ageSurchargeUSD !== 0" class="flex justify-between" [ngClass]="{ 'text-red-500': premium.ageSurchargeUSD > 0, 'text-green-600': premium.ageSurchargeUSD < 0 }">
                                <span>Age-Based Adjustment</span>
                                <span>{{ premium.ageSurchargeUSD > 0 ? '+' : '-' }} $ {{ abs(premium.ageSurchargeUSD) | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.winterSportsSurchargeUSD > 0" class="flex justify-between text-red-500">
                                <span>Winter Sports Surcharge</span>
                                <span>+ $ {{ premium.winterSportsSurchargeUSD | number: '1.2-2' }}</span>
                            </div>
                            <div class="my-2 border-t"></div>
                            <div class="total-payable-text flex items-center justify-between text-xl font-bold">
                                <span>Total Payable</span><span>KES {{ premium.totalPayableKES | number: '1.2-2' }}</span>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button *ngIf="currentStep === 2" (click)="nextStep()" [disabled]="travelerDetailsForm.invalid" class="w-full rounded-md bg-fidelity-primary px-4 py-3 text-sm font-medium text-white hover:bg-white hover:text-fidelity-primary hover:border-2 hover:border-fidelity-primary transition-all duration-300 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed">Review & Save Quote</button>
                            <div *ngIf="currentStep === 3" class="mt-4 flex flex-col gap-4">
                                <button (click)="handlePayment()" class="rounded-md bg-fidelity-primary px-6 py-2 text-sm font-medium text-white hover:bg-white hover:text-fidelity-primary hover:border-2 hover:border-fidelity-primary transition-all duration-300">Proceed to Payment</button>
                            </div>
                             <button (click)="prevStep()" class="mt-2 w-full text-center text-sm font-medium text-gray-600 hover:text-fidelity-primary transition-colors duration-300">Back</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>