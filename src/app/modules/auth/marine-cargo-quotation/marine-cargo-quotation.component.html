<!-- Main container -->
<div class="min-h-screen w-screen bg-gray-50">

    <!-- Header -->
    <header class="sticky top-0 z-10 bg-white shadow-sm">
        <div class="mx-auto max-w-7xl px-4 sm:px-6">
            <div class="flex flex-col items-center justify-between gap-4 py-3 sm:flex-row sm:gap-0 sm:py-4">
                <!-- Logo and Tagline -->
                <div class="flex items-center gap-3 sm:gap-4">
                    <div class="inline-block rounded-2xl bg-fidelity-primary/10 p-2 ring-2 ring-fidelity-primary/20">
                        <img src="https://pbs.twimg.com/profile_images/1767198674373734400/R9lqG20r_400x400.jpg" alt="Fidelity Insurance Logo" class="h-8 w-8 sm:h-10 sm:w-10 rounded-xl object-cover ring-2 ring-fidelity-primary shadow-lg" />
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-fidelity-primary sm:text-xl">Fidelity Marine</h1>
                        <p class="text-xs font-semibold tracking-wide text-fidelity-primary">Insurance You can Trust</p>
                    </div>
                </div>

                <!-- User Info and Actions -->
                <div class="flex flex-wrap items-center justify-center gap-4 sm:flex-nowrap">
                    <!-- Display User Info if Logged In -->
                    <div *ngIf="isLoggedIn" class="flex items-center gap-3 text-sm">
                        <div class="text-right">
                            <span class="font-semibold text-gray-800">{{ user.name }}</span>
                            <span class="block text-xs text-gray-500">{{ user.userType | titlecase }}</span>
                        </div>
                        <button (click)="logout()" class="flex items-center gap-2 rounded-md border border-red-500 bg-red-50 px-3 py-2 text-sm font-medium text-red-600 transition-colors duration-300 hover:bg-red-100" title="Logout">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </button>
                    </div>

                    <!-- Close Button -->
                    <button (click)="closeForm()" class="flex items-center gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors duration-300 hover:bg-gray-50 hover:border-fidelity-primary" title="Close">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-6 lg:p-8">
        <div class="mx-auto max-w-7xl">
            <!-- Progress Steps -->
            <div class="mb-6 sm:mb-8">
                <div class="flex items-center justify-center space-x-4">
                    <!-- Step 1 Indicator -->
                    <div [class]="currentStep >= 1 ? 'flex h-8 w-8 items-center justify-center rounded-full bg-primary text-sm font-medium text-white' : 'flex h-8 w-8 items-center justify-center rounded-full bg-gray-300 text-sm font-medium text-gray-600'">1</div>
                    <span [class]="currentStep >= 1 ? 'ml-2 text-sm font-medium text-primary' : 'ml-2 text-sm text-gray-500'">Shipment Details</span>
                    <div class="h-px w-16 bg-gray-300"></div>
                    <!-- Step 2 Indicator -->
                    <div [class]="currentStep >= 2 ? 'flex h-8 w-8 items-center justify-center rounded-full bg-primary text-sm font-medium text-white' : 'flex h-8 w-8 items-center justify-center rounded-full bg-gray-300 text-sm font-medium text-gray-600'">2</div>
                    <span [class]="currentStep >= 2 ? 'ml-2 text-sm font-medium text-primary' : 'ml-2 text-sm text-gray-500'">Review & Pay</span>
                </div>
            </div>

            <!-- Form and Summary Grid -->
            <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">

                <!-- Left Column: Forms -->
                <div class="lg:col-span-2">
                    <!-- Step 1: Details Form -->
                    <div *ngIf="currentStep === 1" class="step-content rounded-lg bg-white p-6 shadow-sm">
                        <h2 class="mb-2 text-2xl font-semibold text-gray-900">Marine Cargo Quotation Form</h2>
                        <p class="mb-6 text-gray-600">Complete the details below for your marine cargo insurance quote.</p>

                        <form [formGroup]="quotationForm" (ngSubmit)="onSubmit()">
                            <fieldset [disabled]="showHighRiskModal || showExportModal">

                                <!-- 1. Importer Information Section -->
                                <h3 class="mb-4 text-xl font-semibold text-gray-800">Importer Information</h3>
                                <p class="mb-4 text-sm text-gray-500">This is the person or entity purchasing the insurance policy.</p>
                                <div class="mb-4" *ngIf="user">
                                    <label class="inline-flex items-center space-x-2 text-sm font-medium text-gray-700">
                                        <input
                                            type="checkbox"
                                            formControlName="selfAsImporter"
                                            value="self"
                                            (change)="onSelfAsImporterChange($event)"
                                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span>Self as Importer</span>
                                    </label>
                                </div>
                                <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2" *ngIf="displayImporterForm">
                                    <div><label class="mb-2 block text-sm font-medium text-gray-700">First Name <span class="text-red-500">*</span></label><input type="text" formControlName="firstName" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(quotationForm, 'firstName')}"/><div *ngIf="isFieldInvalid(quotationForm, 'firstName')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'firstName') }}</div></div>
                                    <div><label class="mb-2 block text-sm font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label><input type="text" formControlName="lastName" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(quotationForm, 'lastName')}"/><div *ngIf="isFieldInvalid(quotationForm, 'lastName')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'lastName') }}</div></div>
                                    <div><label class="mb-2 block text-sm font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label><input type="email" formControlName="email" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(quotationForm, 'email')}"/><div *ngIf="isFieldInvalid(quotationForm, 'email')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'email') }}</div></div>
                                    <div><label class="mb-2 block text-sm font-medium text-gray-700">Phone Number <span class="text-red-500">*</span></label><input type="tel" formControlName="phoneNumber" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" placeholder="0712345678" [ngClass]="{'border-red-500': isFieldInvalid(quotationForm, 'phoneNumber')}"/><div *ngIf="isFieldInvalid(quotationForm, 'phoneNumber')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'phoneNumber') }}</div></div>

                                </div>

                                <!-- 2. Shipment Details Section -->
                                <h3 class="mb-4 mt-6 border-t pt-6 text-xl font-semibold text-gray-800">Shipment Details</h3>
                                <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <div>
                                        <mat-form-field appearance="outline" class="w-full">
                                            <mat-label>Mode of Shipment</mat-label>
                                            <mat-select formControlName="modeOfShipment" required>
                                                <mat-option value="1">Sea</mat-option>
                                                <mat-option value="2">Air</mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <div *ngIf="isFieldInvalid(quotationForm, 'modeOfShipment')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'modeOfShipment') }}</div>
                                    </div>
                                    <div>
                                        <mat-form-field appearance="outline" class="w-full">
                                            <mat-label>Trade Type</mat-label>
                                            <mat-select formControlName="tradeType" required>
                                                <mat-option value="1">Import</mat-option>
                                                <mat-option value="2">Export</mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <div *ngIf="isFieldInvalid(quotationForm, 'tradeType')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'tradeType') }}</div>
                                    </div>
                                </div>

                                <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Product</label>
                                        <input type="text" formControlName="marineProduct" class="w-full rounded-md border-gray-300 bg-gray-100 px-3 py-2 font-bold text-gray-900" readonly/>
                                    </div>
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Marine Packaging Type <span class="text-red-500">*</span></label>
                                        <div class="flex h-10 items-center gap-4">
                                            <label class="flex items-center"><input type="radio" formControlName="marinePackagingType" value="1" class="h-4 w-4 border-gray-300 text-primary focus-ring-primary"/><span class="ml-2 text-sm text-gray-700">Containerized</span></label>
                                            <label class="flex items-center"><input type="radio" formControlName="marinePackagingType" value="2" class="h-4 w-4 border-gray-300 text-primary focus-ring-primary"/><span class="ml-2 text-sm text-gray-700">Non-Containerized</span></label>
                                        </div>
                                        <div *ngIf="isFieldInvalid(quotationForm, 'marinePackagingType')" class="mt-2 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'marinePackagingType') }}</div>
                                    </div>
                                </div>
                                
                                <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <!-- Updated Select Category with Searchable Dropdown -->
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Select Category <span class="text-red-500">*</span></label>
                                        <mat-form-field appearance="outline" class="w-full category-select">
                                            <mat-select formControlName="marineCategory" (selectionChange)="onCategorySelected($event.value)" #categorySelect>
                                                <mat-option>
                                                    <ngx-mat-select-search [formControl]="categoryFilterCtrl" placeholderLabel="Search categories..."></ngx-mat-select-search>
                                                </mat-option>
                                                <mat-option *ngFor="let category of filteredMarineCategories" [value]="category.catname">
                                                    {{ category.catname }}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <div *ngIf="isFieldInvalid(quotationForm, 'marineCategory')" class="mt-1 text-sm text-red-600">
                                            {{ getErrorMessage(quotationForm, 'marineCategory') }}
                                        </div>
                                    </div>
                                    
                                    <!-- Updated Marine Cargo Type with Searchable Dropdown -->
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Marine Cargo Type <span class="text-red-500">*</span></label>
                                        <mat-form-field appearance="outline" class="w-full cargo-type-select">
                                            <mat-select formControlName="marineCargoType" #cargoTypeSelect [disabled]="isLoadingCargoTypes">
                                                <mat-option>
                                                    <ngx-mat-select-search [formControl]="cargoTypeFilterCtrl" placeholderLabel="Search cargo types..."></ngx-mat-select-search>
                                                </mat-option>
                                                <mat-option *ngFor="let type of filteredMarineCargoTypes" [value]="type.ctname">
                                                    {{ type.ctname }}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <div *ngIf="isLoadingCargoTypes" class="mt-1 text-sm text-gray-500">
                                            Loading cargo types...
                                        </div>
                                        <div *ngIf="isFieldInvalid(quotationForm, 'marineCargoType')" class="mt-1 text-sm text-red-600">
                                            {{ getErrorMessage(quotationForm, 'marineCargoType') }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <!-- Updated Country of Origin with Searchable Dropdown -->
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Country of Origin <span class="text-red-500">*</span></label>
                                        <mat-form-field appearance="outline" class="w-full country-select">
                                            <mat-select formControlName="origin" #countrySelect>
                                                <mat-option>
                                                    <ngx-mat-select-search [formControl]="countryFilterCtrl" placeholderLabel="Search countries..."></ngx-mat-select-search>
                                                </mat-option>
                                                <cdk-virtual-scroll-viewport itemSize="50" class="h-[200px]">
                                                    <mat-option *cdkVirtualFor="let country of filteredCountriesList" [value]="country.id">
                                                        {{ country.countryname }}
                                                    </mat-option>
                                                </cdk-virtual-scroll-viewport>
                                            </mat-select>
                                        </mat-form-field>
                                        <div *ngIf="isFieldInvalid(quotationForm, 'origin')" class="mt-1 text-sm text-red-600">
                                            {{ getErrorMessage(quotationForm, 'origin') }}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Destination</label>
                                        <input type="text" formControlName="destination" class="w-full rounded-md border-gray-300 bg-gray-100 px-3 py-2 text-gray-900 h-14" readonly/>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <label class="mb-2 block text-sm font-medium text-gray-700">Sum Insured (KES) <span class="text-red-500">*</span></label>
                                    <input type="text" formControlName="sumInsured" appThousands placeholder="2,500,000" inputmode="numeric" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(quotationForm, 'sumInsured')}"/>
                                    <div *ngIf="isFieldInvalid(quotationForm, 'sumInsured')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'sumInsured') }}</div>
                                </div>

                                <!-- Terms and Policy Consent -->
                                <div class="mt-6 space-y-2">
                                    <label class="flex items-start"><input type="checkbox" formControlName="termsAndPolicyConsent" class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus-ring-primary"/><span class="ml-3 text-sm text-gray-700">I agree to the <a (click)="openTermsModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Terms of Use</a> and to the <a (click)="openPrivacyModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Data Privacy Policy</a>.*</span></label>
                                    <div *ngIf="isFieldInvalid(quotationForm, 'termsAndPolicyConsent')" class="ml-7 text-sm text-red-600">{{ getErrorMessage(quotationForm, 'termsAndPolicyConsent') }}</div>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit" class="btn-primary mt-8 w-full" [disabled]="isSaving || quotationForm.invalid"><span *ngIf="isSaving" class="animate-spin mr-2 inline-block h-5 w-5 rounded-full border-b-2 border-white"></span>{{ isSaving ? 'Getting Quote...' : 'Get Quote' }}</button>
                            </fieldset>
                        </form>
                    </div>

                    <!-- Step 2: Quote Review & Payment -->
                    <div *ngIf="currentStep === 2" class="step-content rounded-lg bg-white p-6 shadow-sm">
                        <h2 class="mb-4 text-2xl font-semibold text-gray-900">Review Your Quote & Pay</h2>
                        <p class="mb-6 text-gray-600">Please confirm the details below before proceeding to payment.</p>
                        <div class="space-y-6">
                            <!-- Customer Details Summary -->
                            <div>
                                <h3 class="mb-3 border-b pb-2 text-lg font-semibold text-gray-800">Importer Details</h3>
                                <div class="grid grid-cols-1 gap-x-4 gap-y-2 text-sm sm:grid-cols-2" *ngIf="displayImporterForm">
                                    <span class="text-gray-500">Full Name</span><span class="font-medium text-gray-800">{{ quotationForm.value.firstName }} {{ quotationForm.value.lastName }}</span>
                                    <span class="text-gray-500">Email</span><span class="font-medium text-gray-800">{{ quotationForm.value.email }}</span>
                                    <span class="text-gray-500">Phone</span><span class="font-medium text-gray-800">{{ quotationForm.value.phoneNumber }}</span>

                                </div>
                                <div class="grid grid-cols-1 gap-x-4 gap-y-2 text-sm sm:grid-cols-2" *ngIf="!displayImporterForm">
                                    <span class="text-gray-500">Full Name</span><span class="font-medium text-gray-800">{{ user.name}}</span>

                                </div>
                            </div>
                            <!-- Shipment Details Summary -->
                            <div>
                                <h3 class="mb-3 border-b pb-2 text-lg font-semibold text-gray-800">Shipment Details</h3>
                                <div class="grid grid-cols-1 gap-x-4 gap-y-2 text-sm sm:grid-cols-2">
                                    <span class="text-gray-500">Trade / Cargo Type</span><span class="font-medium text-gray-800">{{ quotationForm.value.tradeType === '1' ? 'Import' : 'Export' }} / {{ quotationForm.value.marineCargoType | titlecase }}</span>
                                    <span class="text-gray-500">Origin / Destination</span><span class="font-medium text-gray-800">{{ quotationForm.value.origin }} to {{ quotationForm.value.destination }}</span>
                                    <span class="text-gray-500">Sum Insured (KES)</span><span class="font-medium text-gray-800">{{ quotationForm.value.sumInsured | number:'1.2-2' }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 flex flex-col items-center gap-4 border-t pt-6 sm:flex-row sm:justify-between">
                            <button (click)="goToStep(1)" class="w-full rounded-md border border-gray-300 px-6 py-2 text-sm font-medium text-gray-700 transition-colors duration-300 hover:bg-gray-50 hover:border-fidelity-primary sm:w-auto">Back to Edit</button>
                            <div class="flex w-full flex-col gap-3 sm:w-auto sm:flex-row sm:gap-4">
                                <!-- UPDATED: Changed btn-secondary to btn-primary -->
                                <button (click)="downloadQuote()" class="btn-primary w-full sm:w-auto">Download Quote</button>
                                <button (click)="shareQuote()" class="btn-secondary w-full sm:w-auto flex items-center justify-center gap-2">
                                    <mat-icon class="text-lg">share</mat-icon>
                                    Share Quote
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Premium Summary -->
                <div class="lg:col-span-1">
                    <div class="sticky top-24 rounded-lg bg-white p-6 shadow-sm">
                        <h3 class="mb-4 text-xl font-bold text-gray-800">Premium Summary</h3>
                        <div *ngIf="currentStep === 1" class="flex h-48 items-center justify-center rounded-lg bg-gray-50 p-4">
                            <p class="text-center text-gray-500">Complete the form to see your quote.</p>
                        </div>
                        <div *ngIf="currentStep === 2 && quoteResult?.netprem">
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-gray-600">Sum Insured</span><span class="font-semibold text-gray-900">{{ premiumCalculation.currency }} {{ quotationForm.get('sumInsured')?.value | number: '1.2-2' }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Base Premium</span><span class="font-semibold text-gray-900">{{ premiumCalculation.currency }} {{ quoteResult.premium | number: '1.2-2' }}</span></div>
                                <div class="border-t border-gray-200 pt-3"></div>
                                <div class="flex justify-between"><span class="text-gray-600">PHCF (0.25%)</span><span class="font-semibold text-gray-900">{{ premiumCalculation.currency }} {{ quoteResult.phcf | number: '1.2-2' }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Training Levy (0.25%)</span><span class="font-semibold text-gray-900">{{ premiumCalculation.currency }} {{ quoteResult.tl | number: '1.2-2' }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Stamp Duty</span><span class="font-semibold text-gray-900">{{ premiumCalculation.currency }} {{ quoteResult.sd | number: '1.2-2' }}</span></div>
                                <div class="mt-4 rounded-lg bg-primary p-4 text-white">
                                    <div class="flex items-center justify-between"><span class="text-lg font-semibold">Total Payable</span><span class="text-2xl font-bold">{{ premiumCalculation.currency }} {{ quoteResult.netprem | number: '1.2-2' }}</span></div>
                                </div>
                                <button *ngIf="currentStep === 2 && quoteResult?.netprem" (click)="handlePayment()" class="btn-primary mt-4 w-full">Buy Now</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- REFACTORED MODALS SECTION (Export/High Risk) -->
    <div *ngIf="showExportModal || showHighRiskModal" (click)="closeAllModals()" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4">
        <div (click)="$event.stopPropagation()" class="max-h-[95vh] w-full max-w-3xl overflow-y-auto rounded-lg bg-white p-1 shadow-xl">
            <div class="p-7">
                <h2 class="mb-4 text-2xl font-bold">{{ showExportModal ? 'Export Shipment Details' : 'High-Risk Shipment Details' }}</h2>
                <p class="mb-6 text-gray-600">{{ showExportModal ? 'Please provide the following details for your export request.' : 'Shipments from this origin require manual underwriting. Please provide your details to proceed.' }}</p>

                <form [formGroup]="showExportModal ? exportRequestForm : highRiskRequestForm" (ngSubmit)="showExportModal ? onExportRequestSubmit() : onHighRiskRequestSubmit()">
                    <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                        <!-- Personal Information -->
                        <div><label class="mb-1 block text-sm font-medium">First Name <span class="text-red-500">*</span></label><input type="text" formControlName="firstName" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'firstName')}"/><div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'firstName')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'firstName') }}</div></div>
                        <div><label class="mb-1 block text-sm font-medium">Last Name <span class="text-red-500">*</span></label><input type="text" formControlName="lastName" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'lastName')}"/><div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'lastName')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'lastName') }}</div></div>
                        <div><label class="mb-1 block text-sm font-medium">Email Address <span class="text-red-500">*</span></label><input type="email" formControlName="email" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'email')}"/><div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'email')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'email') }}</div></div>
                        <div><label class="mb-1 block text-sm font-medium">Phone Number <span class="text-red-500">*</span></label><input type="tel" formControlName="phoneNumber" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'phoneNumber')}"/><div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'phoneNumber')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'phoneNumber') }}</div></div>

                        <!-- Shipment Information -->
                        <div>
                            <label class="mb-1 block text-sm font-medium">Country of Origin <span class="text-red-500">*</span></label>
                            <input *ngIf="showExportModal" type="text" formControlName="originCountry" class="w-full rounded-md border bg-gray-100 px-3 py-2 font-semibold text-gray-700" readonly/>
                            <mat-form-field *ngIf="!showExportModal" appearance="outline" class="w-full">
                                <mat-label>Select a country</mat-label>
                                <mat-select formControlName="originCountry">
                                    <mat-option *ngFor="let country of allCountriesList" [value]="country">{{ country }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                            <div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'originCountry')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'originCountry') }}</div>
                        </div>

                        <div>
                            <label class="mb-1 block text-sm font-medium">Destination Country <span class="text-red-500">*</span></label>
                            <!-- Input for High Risk Modal -->
                            <input *ngIf="!showExportModal" type="text" formControlName="destinationCountry" class="w-full rounded-md border bg-gray-100 px-3 py-2 font-bold text-gray-900" readonly/>
                            <!-- Select for Export Modal -->
                            <mat-form-field *ngIf="showExportModal" appearance="outline" class="w-full">
                                <mat-label>Select a country</mat-label>
                                <mat-select formControlName="destinationCountry">
                                    <mat-option *ngFor="let country of exportDestinationCountries" [value]="country">{{ country }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                            <div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'destinationCountry')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'destinationCountry') }}</div>
                        </div>

                        <div>
                            <label class="mb-1 block text-sm font-medium">Shipment Date <span class="text-red-500">*</span></label>
                            <input type="date" formControlName="shipmentDate" [min]="getToday()" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'shipmentDate')}"/>
                            <div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'shipmentDate')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'shipmentDate') }}</div>
                        </div>

                        <div>
                            <label class="mb-1 block text-sm font-medium">Sum Insured (KES) <span class="text-red-500">*</span></label>
                            <input type="text" formControlName="sumInsured" appThousands placeholder="e.g., 1,500,000" inputmode="numeric" class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'sumInsured')}"/>
                            <div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'sumInsured')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'sumInsured') }}</div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="mb-1 block text-sm font-medium">Goods Description (Max 100 words) <span class="text-red-500">*</span></label>
                            <textarea formControlName="goodsDescription" rows="3" placeholder="Describe the goods being shipped..." class="w-full rounded-md border bg-white px-3 py-2 focus-ring-primary" [ngClass]="{'border-red-500': isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'goodsDescription')}"></textarea>
                            <div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'goodsDescription')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'goodsDescription') }}</div>
                        </div>
                    </div>

                    <div class="mt-6 space-y-2">
                        <label class="flex items-start"><input type="checkbox" formControlName="termsAndPolicyConsent" class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus-ring-primary"/><span class="ml-3 text-sm text-gray-700">I agree to the <a (click)="openTermsModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Terms of Use</a> and to the <a (click)="openPrivacyModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Data Privacy Policy</a>.*</span></label>
                        <div *ngIf="isFieldInvalid(showExportModal ? exportRequestForm : highRiskRequestForm, 'termsAndPolicyConsent')" class="ml-7 text-sm text-red-600">{{ getErrorMessage(showExportModal ? exportRequestForm : highRiskRequestForm, 'termsAndPolicyConsent') }}</div>
                    </div>
                    <div class="mt-8 flex justify-end gap-4 border-t pt-6">
                        <button type="button" (click)="closeAllModals()" class="rounded-md border border-gray-300 px-4 py-2 hover:bg-gray-50 transition-colors duration-300">Cancel</button>
                        <button type="submit" [disabled]="(showExportModal ? exportRequestForm : highRiskRequestForm).invalid" class="btn-primary">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Terms of Use Modal -->
    <div *ngIf="showTermsModal" (click)="closeTermsModal()" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4">
        <div (click)="$event.stopPropagation()" class="max-h-[90vh] w-full max-w-4xl overflow-y-auto rounded-lg bg-white shadow-xl">
            <div class="sticky top-0 border-b bg-white px-6 py-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900">Terms of Use</h2>
                    <button (click)="closeTermsModal()" class="text-gray-400 hover:text-fidelity-primary transition-colors duration-300"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
            </div>
            <div class="p-6">
                <div class="prose max-w-none text-gray-700">
                    <h3 class="mb-4 text-lg font-semibold">Terms of Use and Data Privacy Policy</h3>
                    <p class="mb-4">Fidelity Insurance Company Limited is committed to protecting the fundamental human right to privacy of those with whom we interact. We recognize the need to safeguard personal data that is collected or disclosed to us as part of the Know-your-customer information required by us in order to provide you with the requisite financial product or service.</p>
                    <p class="mb-4">We are committed to complying with the requirements of the Data Protection Act and the attendant regulations as well as best global best practices regarding the processing of your personal data. In this regard, you are required to acquaint yourselves with our data privacy statement which is intended to tell you how we use your personal data and describes how we collect and process your personal data during and after your relationship.</p>
                    <div class="mt-6 rounded-lg p-4" style="background-color: rgba(183, 220, 120, 0.1);"><p class="text-sm" style="color: #007B7B;"><strong>External Link:</strong> For complete terms and conditions, please visit: <a href="https://fidelity.co.ke/data-privacy-statement/" target="_blank" class="ml-1 font-medium text-fidelity-primary hover:underline transition-colors duration-300">https://fidelity.co.ke/data-privacy-statement/</a></p></div>
                </div>
                <div class="mt-8 flex justify-end border-t pt-4"><button (click)="closeTermsModal()" class="btn-primary">I Understand</button></div>
            </div>
        </div>
    </div>

    <!-- Data Privacy Policy Modal -->
    <div *ngIf="showPrivacyModal" (click)="closePrivacyModal()" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4">
        <div (click)="$event.stopPropagation()" class="max-h-[90vh] w-full max-w-4xl overflow-y-auto rounded-lg bg-white shadow-xl">
            <div class="sticky top-0 border-b bg-white px-6 py-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900">Data Privacy Policy</h2>
                    <button (click)="closePrivacyModal()" class="text-gray-400 hover:text-fidelity-primary transition-colors duration-300"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
            </div>
            <div class="p-6">
                <div class="prose max-w-none text-gray-700">
                    <h3 class="mb-4 text-lg font-semibold">Data Privacy Statement</h3>
                    <p class="mb-4">Fidelity Insurance Company Limited is committed to protecting the fundamental human right to privacy of those with whom we interact. We recognize the need to safeguard personal data that is collected or disclosed to us as part of the Know-your-customer information required by us in order to provide you with the requisite financial product or service.</p>
                    <p class="mb-4">We are committed to complying with the requirements of the Data Protection Act and the attendant regulations as well as best global best practices regarding the processing of your personal data. In this regard, you are required to acquaint yourselves with our data privacy statement which is intended to tell you how we use your personal data and describes how we collect and process your personal data during and after your relationship.</p>
                    <div class="mt-6 rounded-lg p-4" style="background-color: rgba(183, 220, 120, 0.1);"><p class="text-sm" style="color: #007B7B;"><strong>External Link:</strong> For complete privacy policy details, please visit: <a href="https://fidelity.co.ke/data-privacy-statement/" target="_blank" class="ml-1 font-medium text-fidelity-primary hover:underline transition-colors duration-300">https://fidelity.co.ke/data-privacy-statement/</a></p></div>
                </div>
                <div class="mt-8 flex justify-end border-t pt-4"><button (click)="closePrivacyModal()" class="btn-primary">I Understand</button></div>
            </div>
        </div>
    </div>

    <!-- Universal Toast Message -->
    <div *ngIf="toastMessage" class="animate-fade-in-out fixed bottom-5 right-5 z-50 rounded-lg px-5 py-3 text-white shadow-lg transition-opacity duration-300" style="background-color: #007B7B;">{{ toastMessage }}</div>

</div>
